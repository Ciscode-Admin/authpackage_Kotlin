trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk

steps:
  - checkout: self
    fetchDepth: 0

  - task: JavaToolInstaller@0
    inputs:
      versionSpec: '21'
      jdkArchitectureOption: 'x64'
      jdkSourceOption: 'PreInstalled'
    displayName: 'Use Java 21'

  - script: chmod +x ./gradlew
    displayName: 'Make gradlew executable'

  - task: Cache@2
    displayName: 'Cache Gradle'
    inputs:
      key: 'gradle | "$(Agent.OS)" | **/gradle-wrapper.properties'
      restoreKeys: |
        gradle | "$(Agent.OS)"
      path: '$(HOME)/.gradle/caches'

  - bash: |
      set -e
      yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --licenses
      "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" \
        "platforms;android-35" "build-tools;35.0.0" "platform-tools"
    displayName: 'Ensure Android SDK 35 is installed'

  # Prepare SonarCloud (service connection name must match)
  - task: SonarCloudPrepare@1
    displayName: 'Prepare SonarCloud analysis'
    inputs:
      SonarCloud: 'Sonarqube Cloud'
      organization: 'ciscode'
      scannerMode: 'Other'
      projectKey: 'CISCODEAPPS_pkg-android-auth'
      projectName: 'pkg-android-auth'

  # Run tests + generate coverage XML
  - bash: ./gradlew clean :testDebugUnitTest jacocoTestReport --stacktrace --info --no-daemon || true
    displayName: 'Run unit tests (debug) + coverage'

  # Publish test results so you can see counts/failures in the run
  - task: PublishTestResults@2
    displayName: 'Publish JUnit results'
    condition: always()
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: '**/build/test-results/testDebugUnitTest/*.xml'
      searchFolder: '$(System.DefaultWorkingDirectory)'
      failTaskOnFailedTests: true

  # (Optional) Upload the coverage XML as a pipeline artifact for debugging
  - task: PublishBuildArtifacts@1
    displayName: 'Attach jacoco XML (debugging)'
    condition: always()
    inputs:
      PathtoPublish: 'build/reports/jacoco/jacocoTestReport/jacocoTestReport.xml'
      ArtifactName: 'coverage-xml'
      publishLocation: 'Container'

  # Run the Sonar analysis (the Gradle task now dependsOn jacocoTestReport)
  - bash: ./gradlew sonarqube --stacktrace --no-daemon
    displayName: 'Run SonarCloud analysis (Gradle)'

  - task: SonarCloudPublish@1
    displayName: 'Publish SonarCloud Quality Gate'
    inputs:
      pollingTimeoutSec: '300'

  - bash: ./gradlew :assembleRelease
    displayName: 'Build release AAR'

  - bash: |
      set -euo pipefail
      GROUP=$(grep -Po '^group\s*=\s*"\K[^"]+' build.gradle.kts)
      VERSION=$(grep -Po '^version\s*=\s*"\K[^"]+' build.gradle.kts)
      ARTIFACT=$(grep -Po 'artifactId\s*=\s*"\K[^"]+' build.gradle.kts | head -n1)
      if [ -z "${GROUP:-}" ] || [ -z "${VERSION:-}" ] || [ -z "${ARTIFACT:-}" ]; then
        echo "Failed to parse GROUP/ARTIFACT/VERSION from build.gradle.kts"
        exit 1
      fi
      GROUP_PATH=${GROUP//./\/}
      URL="https://pkgs.dev.azure.com/CISCODEAPPS/_packaging/android-packages/maven/v1/${GROUP_PATH}/${ARTIFACT}/${VERSION}/${ARTIFACT}-${VERSION}.aar"
      echo "Checking ${URL}"
      STATUS=$(curl -s -o /dev/null -w "%{http_code}" -I -u "azdo:${AZURE_ARTIFACTS_TOKEN}" "${URL}")
      if [ "${STATUS}" = "200" ]; then
        echo "##vso[task.setvariable variable=PUBLISH_NEEDED]false"
      else
        echo "##vso[task.setvariable variable=PUBLISH_NEEDED]true"
      fi
    displayName: 'Check if version exists in feed'
    env:
      AZURE_ARTIFACTS_TOKEN: $(System.AccessToken)

  - bash: ./gradlew publishAuthuiReleasePublicationToAzureArtifactsRepository --stacktrace --no-daemon
    displayName: 'Publish authui (release) to android-packages'
    condition: and(succeeded(), eq(variables.PUBLISH_NEEDED, 'true'))
    env:
      AZURE_ARTIFACTS_USERNAME: 'azdo'
      AZURE_ARTIFACTS_TOKEN: $(System.AccessToken)

  - bash: echo "Publish skipped (same version already present)."
    displayName: 'Skip note'
    condition: and(succeeded(), eq(variables.PUBLISH_NEEDED, 'false'))