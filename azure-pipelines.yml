trigger:
  - release

pool:
  vmImage: ubuntu-latest

variables:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk

steps:
  - checkout: self
    fetchDepth: 0

  - task: JavaToolInstaller@0
    inputs:
      versionSpec: '21'
      jdkArchitectureOption: 'x64'
      jdkSourceOption: 'PreInstalled'
    displayName: Use Java 21

  - script: chmod +x ./gradlew
    displayName: Make gradlew executable

  - task: Cache@2
    displayName: Cache Gradle
    inputs:
      key: 'gradle | "$(Agent.OS)" | **/gradle-wrapper.properties'
      restoreKeys: |
        gradle | "$(Agent.OS)"
      path: '$(HOME)/.gradle/caches'

  - bash: |
      set -e
      yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --licenses
      "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" \
        "platforms;android-35" "build-tools;35.0.0" "platform-tools"
    displayName: Ensure Android SDK 35 is installed

  # ---- SONARCLOUD: PREPARE ----
  - task: SonarCloudPrepare@1
    displayName: Prepare SonarCloud analysis
    inputs:
      SonarCloud: 'Sonarqube Cloud'
      organization: 'ciscode'
      scannerMode: 'Other'
      projectKey: 'CISCODEAPPS_pkg-android-auth'
      projectName: 'pkg-android-auth'

  # ---- TESTS + COVERAGE ----
  - bash: ./gradlew clean :testDebugUnitTest jacocoTestReport --stacktrace --info --no-daemon || true
    displayName: Run unit tests (debug) + coverage

  - bash: ./gradlew sonarqube --stacktrace --no-daemon
    displayName: Run SonarCloud analysis (Gradle)

  - task: SonarCloudPublish@1
    displayName: Publish SonarCloud Quality Gate
    inputs:
      pollingTimeoutSec: '300'

  - bash: ./gradlew :assembleRelease --no-daemon
    displayName: Build release AAR

  # ---- VERIFY CENTRAL PORTAL TOKEN (tolerate 5xx, fail on 401) ----
  - bash: |
      set -euo pipefail
      echo "Checking Central Publisher API with provided credentials..."
      echo "LEN USER=$(printf %s "$CENTRAL_USERNAME" | wc -c)  LEN PASS=$(printf %s "$CENTRAL_PASSWORD" | wc -c)"

      tries=0
      max=3
      rc=0
      while (( tries < max )); do
        tries=$((tries+1))
        echo "Attempt $tries/$max..."
        BODY_FILE="$(mktemp)"
        CODE=$(curl -sS -o "$BODY_FILE" -w "%{http_code}" -u "$CENTRAL_USERNAME:$CENTRAL_PASSWORD" \
          https://central.sonatype.com/api/v1/publisher/status || true)

        echo "HTTP=$CODE"
        if [[ "$CODE" == "200" ]]; then
          echo "Central Publisher API reachable and credentials accepted."
          rm -f "$BODY_FILE"
          exit 0
        fi

        echo "Response body:"
        sed -e 's/.*/  &/' "$BODY_FILE" || true
        rm -f "$BODY_FILE"

        # Hard fail on confirmed bad creds
        if [[ "$CODE" == "401" ]]; then
          echo "Invalid token (401). Check CENTRAL_USERNAME/CENTRAL_PASSWORD from Central Portal (Settings â†’ User Tokens)."
          exit 1
        fi

        # Retry on anything else (network hiccup / 5xx)
        sleep 3
      done

      echo "Central Publisher status kept failing (e.g., 5xx). Proceeding so nmcp can attempt real upload."
      exit 0
    displayName: Verify Central Portal token (resilient)
    env:
      CENTRAL_USERNAME: $(CENTRAL_USERNAME)
      CENTRAL_PASSWORD: $(CENTRAL_PASSWORD)

  # ---- PUBLISH TO MAVEN CENTRAL (Central Portal via nmcp) ----
  - bash: ./gradlew publishAggregationToCentralPortal --stacktrace --no-daemon
    displayName: Publish to Maven Central (Central Portal via nmcp)
    env:
      CENTRAL_USERNAME: $(CENTRAL_USERNAME)
      CENTRAL_PASSWORD: $(CENTRAL_PASSWORD)