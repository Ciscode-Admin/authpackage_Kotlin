trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk

steps:
  - checkout: self
    fetchDepth: 0

  - task: JavaToolInstaller@0
    displayName: Use Java 17
    inputs:
      versionSpec: '17'
      jdkArchitectureOption: x64
      jdkSourceOption: PreInstalled

  - script: chmod +x ./gradlew
    displayName: Make gradlew executable

  - task: Cache@2
    displayName: Cache Gradle
    inputs:
      key: 'gradle | "$(Agent.OS)" | **/gradle-wrapper.properties'
      restoreKeys: |
        gradle | "$(Agent.OS)"
      path: '$(HOME)/.gradle/caches'

  - bash: |
      set -e
      yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --licenses
      "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" \
        "platforms;android-35" "build-tools;35.0.0" "platform-tools"
    displayName: Ensure Android SDK 35 is installed

  - task: SonarCloudPrepare@1
    displayName: Prepare SonarCloud analysis
    inputs:
      SonarCloud: 'Sonarqube Cloud'
      organization: 'ciscode'
      scannerMode: 'Other'
      projectKey: 'CISCODEAPPS_pkg-android-auth'
      projectName: 'pkg-android-auth'

  - bash: ./gradlew clean :testDebugUnitTest jacocoTestReport --stacktrace --info --no-daemon
    displayName: Run unit tests (debug) + coverage

  - task: PublishTestResults@2
    displayName: Publish JUnit results
    condition: always()
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: '**/build/test-results/testDebugUnitTest/*.xml'
      searchFolder: '$(System.DefaultWorkingDirectory)'
      failTaskOnFailedTests: true
      testRunTitle: 'Unit tests (debug)'

  - bash: |
      set -x
      XML_DEFAULT="build/reports/jacoco/jacocoTestReport/jacocoTestReport.xml"
      COV_XML=""
      if [ -f "$XML_DEFAULT" ]; then
        COV_XML="$XML_DEFAULT"
      else
        COV_XML="$(find "$PWD" -type f -name 'jacocoTestReport.xml' -printf '%s %p\n' 2>/dev/null \
                    | sort -nr | awk 'NR==1{print $2}')"
      fi
      echo "COVERAGE_XML resolved to: ${COV_XML:-<none>}"
      if [ -n "$COV_XML" ] && [ -f "$COV_XML" ]; then
        echo "##vso[task.setvariable variable=COVERAGE_XML]$COV_XML"
      else
        echo "##vso[task.setvariable variable=COVERAGE_XML]"
      fi

      SRC_DIRS=()
      [ -d "src/main/java" ] && SRC_DIRS+=("src/main/java")
      [ -d "src/main/kotlin" ] && SRC_DIRS+=("src/main/kotlin")
      SONAR_SOURCES="$(IFS=, ; echo "${SRC_DIRS[*]}")"
      echo "##vso[task.setvariable variable=SONAR_SOURCES]$SONAR_SOURCES"

      TEST_DIRS=()
      [ -d "src/test/java" ] && TEST_DIRS+=("src/test/java")
      [ -d "src/test/kotlin" ] && TEST_DIRS+=("src/test/kotlin")
      SONAR_TESTS="$(IFS=, ; echo "${TEST_DIRS[*]}")"
      echo "##vso[task.setvariable variable=SONAR_TESTS]$SONAR_TESTS"

      BIN_DIRS=()
      [ -d "build/intermediates/javac/debug/classes" ] && BIN_DIRS+=("build/intermediates/javac/debug/classes")
      [ -d "build/tmp/kotlin-classes/debug" ] && BIN_DIRS+=("build/tmp/kotlin-classes/debug")
      mapfile -t JARS < <(find build/intermediates -type f -name classes.jar 2>/dev/null || true)
      BIN_LIST="$(IFS=, ; echo "${BIN_DIRS[*]}")"
      for j in "${JARS[@]}"; do
        if [ -z "$BIN_LIST" ]; then BIN_LIST="$j"; else BIN_LIST="$BIN_LIST,$j"; fi
      done
      echo "##vso[task.setvariable variable=SONAR_BINARIES]$BIN_LIST"
    displayName: Discover coverage XML, sources, tests, binaries
    continueOnError: true

  - bash: |
      set -e
      ./gradlew sonarqube \
        -Dsonar.java.binaries="$(SONAR_BINARIES)" \
        -Dsonar.coverage.jacoco.xmlReportPaths="$(COVERAGE_XML)" \
        --stacktrace --no-daemon
    displayName: Run SonarCloud analysis (Gradle)
    condition: succeeded()

  - task: SonarCloudPublish@1
    displayName: Publish SonarCloud Quality Gate
    inputs:
      pollingTimeoutSec: '300'
    condition: succeeded()

  - bash: ./gradlew :assembleRelease --no-daemon
    displayName: Build release AAR
    condition: succeeded()

  # ---------- Azure Artifacts: publish if version not present ----------
  # Robust check that NEVER fails the job. We hard-code Azure coords to
  # match the Gradle publication (groupId=com.ciscod.android, artifactId=authui).
  - bash: |
      set +e  # do not fail this step
      VERSION="$(awk -F'"' '/^version[[:space:]]*=/ {print $2; exit}' build.gradle.kts)"
      AZ_GROUP="com.ciscod.android"
      AZ_ARTIFACT="authui"

      if [ -z "$VERSION" ]; then
        echo "Could not parse version from build.gradle.kts; default to publishing."
        echo "##vso[task.setvariable variable=PUBLISH_NEEDED]true"
        exit 0
      fi

      GROUP_PATH=${AZ_GROUP//./\/}
      URL="https://pkgs.dev.azure.com/CISCODEAPPS/_packaging/android-packages/maven/v1/${GROUP_PATH}/${AZ_ARTIFACT}/${VERSION}/${AZ_ARTIFACT}-${VERSION}.aar"

      STATUS="$(curl -sS -o /dev/null -w '%{http_code}' -I -u "azdo:${AZURE_ARTIFACTS_TOKEN}" "$URL" 2>/dev/null || echo 000)"
      echo "HEAD $URL -> $STATUS"

      if [ "$STATUS" = "200" ]; then
        echo "##vso[task.setvariable variable=PUBLISH_NEEDED]false"
      else
        echo "##vso[task.setvariable variable=PUBLISH_NEEDED]true"
      fi
      # Always succeed
      exit 0
    displayName: Check if version exists in Azure feed (robust)
    env:
      AZURE_ARTIFACTS_TOKEN: $(System.AccessToken)
    condition: succeeded()

  - bash: ./gradlew publishAuthuiReleasePublicationToAzureArtifactsRepository --stacktrace --no-daemon
    displayName: Publish authui (release) to Azure Artifacts
    condition: and(succeeded(), eq(variables.PUBLISH_NEEDED, 'true'))
    env:
      AZURE_ARTIFACTS_USERNAME: 'azdo'
      AZURE_ARTIFACTS_TOKEN: $(System.AccessToken)

  - bash: echo "Azure publish skipped (same version already present)."
    displayName: Skip note (Azure)
    condition: and(succeeded(), eq(variables.PUBLISH_NEEDED, 'false'))

  # ---------- Maven Central: publish with Vanniktech (tags only) ----------
  - bash: ./gradlew publishAllPublicationsToMavenCentralRepository --stacktrace --no-daemon
    displayName: Publish to Maven Central (Vanniktech)
    condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/tags/'))
    env:
      ORG_GRADLE_PROJECT_mavenCentralUsername: $(SONATYPE_USERNAME)
      ORG_GRADLE_PROJECT_mavenCentralPassword: $(SONATYPE_PASSWORD)
      ORG_GRADLE_PROJECT_signingInMemoryKey: $(SIGNING_KEY)
      ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: $(SIGNING_PASSWORD)