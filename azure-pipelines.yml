trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk

steps:
  - checkout: self
    fetchDepth: 0

  - task: JavaToolInstaller@0
    displayName: Use Java 21
    inputs:
      versionSpec: '21'
      jdkArchitectureOption: x64
      jdkSourceOption: PreInstalled

  - script: chmod +x ./gradlew
    displayName: Make gradlew executable

  - task: Cache@2
    displayName: Cache Gradle
    inputs:
      key: 'gradle | "$(Agent.OS)" | **/gradle-wrapper.properties'
      restoreKeys: |
        gradle | "$(Agent.OS)"
      path: '$(HOME)/.gradle/caches'

  - bash: |
      set -e
      yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --licenses
      "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" \
        "platforms;android-35" "build-tools;35.0.0" "platform-tools"
    displayName: Ensure Android SDK 35 is installed

  # SonarCloud service connection name must match your DevOps connection
  - task: SonarCloudPrepare@1
    displayName: Prepare SonarCloud analysis
    inputs:
      SonarCloud: 'Sonarqube Cloud'
      organization: 'ciscode'
      scannerMode: 'Other'
      projectKey: 'CISCODEAPPS_pkg-android-auth'
      projectName: 'pkg-android-auth'

  # Run unit tests and generate JaCoCo XML
  - bash: ./gradlew clean :testDebugUnitTest jacocoTestReport --stacktrace --info --no-daemon || true
    displayName: Run unit tests (debug) + coverage

  # Publish JUnit results so failures/counts show up in the run
  - task: PublishTestResults@2
    displayName: Publish JUnit results
    condition: always()
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: '**/build/test-results/testDebugUnitTest/*.xml'
      searchFolder: '$(System.DefaultWorkingDirectory)'
      failTaskOnFailedTests: true

  # Discover coverage XML, sources, tests, and binaries (only include paths that exist)
  - bash: |
      set -euo pipefail

      echo "PWD: $PWD"
      echo "Listing JaCoCo report dirs (if present):"
      ls -la build/reports/jacoco || true
      ls -la build/reports/jacoco/jacocoTestReport || true

      # 1) Coverage XML (prefer default path; otherwise scan and take the largest)
      XML_DEFAULT="build/reports/jacoco/jacocoTestReport/jacocoTestReport.xml"
      if [ -f "$XML_DEFAULT" ]; then
        COV_XML="$XML_DEFAULT"
      else
        COV_XML="$(find "$PWD" -type f -name 'jacocoTestReport.xml' -printf '%s %p\n' \
                    | sort -nr | awk 'NR==1{print $2}')"
      fi
      echo "Coverage XML: ${COV_XML:-<none>}"
      if [ -z "${COV_XML:-}" ] || [ ! -f "$COV_XML" ]; then
        echo "ERROR: JaCoCo XML not found. Failing fast to avoid 0% coverage import."
        exit 1
      fi
      echo "##vso[task.setvariable variable=COVERAGE_XML]$COV_XML"

      # 2) Sources (dynamic)
      SRC_DIRS=()
      [ -d "src/main/java" ] && SRC_DIRS+=("src/main/java")
      [ -d "src/main/kotlin" ] && SRC_DIRS+=("src/main/kotlin")
      SONAR_SOURCES="$(IFS=, ; echo "${SRC_DIRS[*]}")"
      echo "Sources: ${SONAR_SOURCES:-<none>}"
      echo "##vso[task.setvariable variable=SONAR_SOURCES]$SONAR_SOURCES"

      # 3) Tests (dynamic â€” avoids missing-folder errors)
      TEST_DIRS=()
      [ -d "src/test/java" ] && TEST_DIRS+=("src/test/java")
      [ -d "src/test/kotlin" ] && TEST_DIRS+=("src/test/kotlin")
      SONAR_TESTS="$(IFS=, ; echo "${TEST_DIRS[*]}")"
      echo "Tests: ${SONAR_TESTS:-<none>}"
      echo "##vso[task.setvariable variable=SONAR_TESTS]$SONAR_TESTS"

      # 4) Binaries (AGP 8.x)
      BIN_DIRS=()
      [ -d "build/intermediates/javac/debug/classes" ] && BIN_DIRS+=("build/intermediates/javac/debug/classes")
      [ -d "build/tmp/kotlin-classes/debug" ] && BIN_DIRS+=("build/tmp/kotlin-classes/debug")
      # Also include any classes.jar artifacts under intermediates
      mapfile -t JARS < <(find build/intermediates -type f -name classes.jar 2>/dev/null || true)

      BIN_LIST="$(IFS=, ; echo "${BIN_DIRS[*]}")"
      for j in "${JARS[@]}"; do
        if [ -z "$BIN_LIST" ]; then BIN_LIST="$j"; else BIN_LIST="$BIN_LIST,$j"; fi
      done

      echo "Sonar java.binaries:"
      echo "${BIN_LIST:-<none>}" | tr ',' '\n'
      echo "##vso[task.setvariable variable=SONAR_BINARIES]$BIN_LIST"
    displayName: Discover coverage XML, sources, tests, binaries

  # Attach the discovered XML so you can open it from the run
  - task: PublishBuildArtifacts@1
    displayName: Attach jacoco XML (debugging)
    condition: always()
    inputs:
      PathtoPublish: '$(COVERAGE_XML)'
      ArtifactName: 'coverage-xml'
      publishLocation: 'Container'

  # Run Sonar with explicit, discovered inputs
  - bash: |
      set -e
      ./gradlew sonarqube \
        -Dsonar.sources="$(SONAR_SOURCES)" \
        -Dsonar.tests="$(SONAR_TESTS)" \
        -Dsonar.java.binaries="$(SONAR_BINARIES)" \
        -Dsonar.coverage.jacoco.xmlReportPaths="$(COVERAGE_XML)" \
        --stacktrace --no-daemon
    displayName: Run SonarCloud analysis (Gradle)

  - task: SonarCloudPublish@1
    displayName: Publish SonarCloud Quality Gate
    inputs:
      pollingTimeoutSec: '300'

  - bash: ./gradlew :assembleRelease
    displayName: Build release AAR

  # Skip publishing if the same version already exists in your Azure Artifacts feed
  - bash: |
      set -euo pipefail
      GROUP=$(grep -Po '^group\s*=\s*"\K[^"]+' build.gradle.kts)
      VERSION=$(grep -Po '^version\s*=\s*"\K[^"]+' build.gradle.kts)
      ARTIFACT=$(grep -Po 'artifactId\s*=\s*"\K[^"]+' build.gradle.kts | head -n1)
      if [ -z "${GROUP:-}" ] || [ -z "${VERSION:-}" ] || [ -z "${ARTIFACT:-}" ]; then
        echo "POM coords not found in build.gradle.kts"; exit 1
      fi
      GROUP_PATH=${GROUP//./\/}
      URL="https://pkgs.dev.azure.com/CISCODEAPPS/_packaging/android-packages/maven/v1/${GROUP_PATH}/${ARTIFACT}/${VERSION}/${ARTIFACT}-${VERSION}.aar"
      STATUS=$(curl -s -o /dev/null -w "%{http_code}" -I -u "azdo:${AZURE_ARTIFACTS_TOKEN}" "${URL}")
      if [ "${STATUS}" = "200" ]; then
        echo "##vso[task.setvariable variable=PUBLISH_NEEDED]false"
      else
        echo "##vso[task.setvariable variable=PUBLISH_NEEDED]true"
      fi
    displayName: Check if version exists in feed
    env:
      AZURE_ARTIFACTS_TOKEN: $(System.AccessToken)

  - bash: ./gradlew publishAuthuiReleasePublicationToAzureArtifactsRepository --stacktrace --no-daemon
    displayName: Publish authui (release) to android-packages
    condition: and(succeeded(), eq(variables.PUBLISH_NEEDED, 'true'))
    env:
      AZURE_ARTIFACTS_USERNAME: 'azdo'
      AZURE_ARTIFACTS_TOKEN: $(System.AccessToken)

  - bash: echo "Publish skipped (same version already present)."
    displayName: Skip note
    condition: and(succeeded(), eq(variables.PUBLISH_NEEDED, 'false'))