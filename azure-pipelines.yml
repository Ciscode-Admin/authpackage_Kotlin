trigger:
  - release

pool:
  vmImage: ubuntu-latest

variables:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk

steps:
  - checkout: self
    fetchDepth: 0

  - task: JavaToolInstaller@0
    inputs:
      versionSpec: '21'
      jdkArchitectureOption: 'x64'
      jdkSourceOption: 'PreInstalled'
    displayName: Use Java 21

  - script: chmod +x ./gradlew
    displayName: Make gradlew executable

  - task: Cache@2
    displayName: Cache Gradle
    inputs:
      key: 'gradle | "$(Agent.OS)" | **/gradle-wrapper.properties'
      restoreKeys: |
        gradle | "$(Agent.OS)"
      path: '$(HOME)/.gradle/caches'

  - bash: |
      set -e
      yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --licenses
      "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" \
        "platforms;android-35" "build-tools;35.0.0" "platform-tools"
    displayName: Ensure Android SDK 35 is installed

  # ---- SONARCLOUD: PREPARE ----
  - task: SonarCloudPrepare@1
    displayName: Prepare SonarCloud analysis
    inputs:
      SonarCloud: 'Sonarqube Cloud'
      organization: 'ciscode'
      scannerMode: 'Other'
      projectKey: 'CISCODEAPPS_pkg-android-auth'
      projectName: 'pkg-android-auth'

  # ---- TESTS + COVERAGE ----
  - bash: ./gradlew clean :testDebugUnitTest jacocoTestReport --stacktrace --info --no-daemon || true
    displayName: Run unit tests (debug) + coverage

  # ---- SONARCLOUD ANALYSIS ----
  - bash: ./gradlew sonarqube --stacktrace --no-daemon
    displayName: Run SonarCloud analysis (Gradle)

  - task: SonarCloudPublish@1
    displayName: Publish SonarCloud Quality Gate
    inputs:
      pollingTimeoutSec: '300'

  # ---- BUILD RELEASE AAR ----
  - bash: ./gradlew :assembleRelease --stacktrace --no-daemon
    displayName: Build release AAR

  # ---- VERIFY SONATYPE TOKEN (robust: handles colons/special chars/newlines) ----
  - bash: |
      set -euo pipefail

      if [ -z "${SONATYPE_USERNAME:-}" ] || [ -z "${SONATYPE_PASSWORD:-}" ]; then
        echo "Sonatype creds not present in environment."
        exit 1
      fi

      auth="$(printf '%s:%s' "$SONATYPE_USERNAME" "$SONATYPE_PASSWORD" | base64 -w0 2>/dev/null || printf '%s:%s' "$SONATYPE_USERNAME" "$SONATYPE_PASSWORD" | base64)"
      code="$(curl -s -o /dev/null -w '%{http_code}' \
        -H "Authorization: Basic $auth" \
        https://s01.oss.sonatype.org/service/local/staging/profiles)"

      echo "HTTP=$code"
      test "$code" = "200"
    displayName: Verify Sonatype token (curl)
    env:
      SONATYPE_USERNAME: $(SONATYPE_USERNAME)
      SONATYPE_PASSWORD: $(SONATYPE_PASSWORD)

  # ---- PUBLISH TO SONATYPE (MAVEN CENTRAL) ----
  - bash: ./gradlew publishAuthuiReleasePublicationToSonatypeRepository --stacktrace --no-daemon
    displayName: Publish authui (release) to Maven Central (Sonatype)
    env:
      SONATYPE_USERNAME: $(SONATYPE_USERNAME)
      SONATYPE_PASSWORD: $(SONATYPE_PASSWORD)
      ORG_GRADLE_PROJECT_signingKey: $(SIGNING_KEY)
      ORG_GRADLE_PROJECT_signingPassword: $(SIGNING_PASSWORD)