trigger:
  - release

pool:
  vmImage: ubuntu-latest

variables:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk

steps:
  - checkout: self
    fetchDepth: 0
    persistCredentials: true   # IMPORTANT: avoids Azure DevOps auth prompts during git fetch

  - task: JavaToolInstaller@0
    inputs:
      versionSpec: '21'
      jdkArchitectureOption: 'x64'
      jdkSourceOption: 'PreInstalled'
    displayName: Use Java 21

  - script: chmod +x ./gradlew
    displayName: Make gradlew executable

  - task: Cache@2
    displayName: Cache Gradle
    inputs:
      key: 'gradle | "$(Agent.OS)" | **/gradle-wrapper.properties'
      restoreKeys: |
        gradle | "$(Agent.OS)"
      path: '$(HOME)/.gradle/caches'

  - bash: |
      set -e
      yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --licenses
      "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" \
        "platforms;android-35" "build-tools;35.0.0" "platform-tools"
    displayName: Ensure Android SDK 35 is installed

  # ---- SonarCloud ----
  - task: SonarCloudPrepare@1
    displayName: Prepare SonarCloud analysis
    inputs:
      SonarCloud: 'Sonarqube Cloud'
      organization: 'ciscode'
      scannerMode: 'Other'
      projectKey: 'CISCODEAPPS_pkg-android-auth'
      projectName: 'pkg-android-auth'

  - bash: ./gradlew clean :testDebugUnitTest jacocoTestReport --stacktrace --info --no-daemon || true
    displayName: Run unit tests (debug) + coverage

  - bash: ./gradlew sonarqube --stacktrace --no-daemon
    displayName: Run SonarCloud analysis (Gradle)

  - task: SonarCloudPublish@1
    displayName: Publish SonarCloud Quality Gate
    inputs:
      pollingTimeoutSec: '300'

  - bash: ./gradlew :assembleRelease --no-daemon
    displayName: Build release AAR

  # ---- Publish to Maven Central (leave as-is if you still want it) ----
  - bash: ./gradlew publishAggregationToCentralPortal --stacktrace --no-daemon
    displayName: Publish to Maven Central (Central Portal via nmcp)
    env:
      CENTRAL_USERNAME: $(CENTRAL_USERNAME)
      CENTRAL_PASSWORD: $(CENTRAL_PASSWORD)
      SIGNING_KEY_FILE: $(gpgkey.secureFilePath)
      SIGNING_PASSWORD: $(SIGNING_PASSWORD)
      SIGNING_KEY: ''

  # ---- Sync Azure DevOps release -> GitHub release (ONLY if everything above succeeded) ----
  - bash: |
      set -euo pipefail
      export GIT_TERMINAL_PROMPT=0

      echo "=== Sync Azure DevOps 'release' -> GitHub 'release' (force) ==="

      # Ensure we are on the latest Azure DevOps release branch
      git fetch origin release
      git checkout -B release origin/release

      # Configure Git identity (required by some agents)
      git config user.email "azure-pipelines@local"
      git config user.name  "azure-pipelines"

      # Add / update GitHub remote (do not embed token in the URL)
      git remote remove github 2>/dev/null || true
      git remote add github "https://github.com/ASMAEELKHIRAOUI/login-kotlin.git"

      # Use PAT via HTTP header (safe; avoids username/password prompts)
      AUTH_HEADER="AUTHORIZATION: basic $(printf 'x-access-token:%s' "$GITHUB_PAT" | base64 -w0)"

      # Force push the release branch so GitHub matches Azure exactly
      git -c http.extraheader="$AUTH_HEADER" push --force github release:release

      # Optional: push tags too (remove if you don't want tags synced)
      git -c http.extraheader="$AUTH_HEADER" push --force github --tags

      echo "=== Sync completed ==="
    displayName: Sync release branch to GitHub (force)
    env:
      GITHUB_PAT: $(GITHUB_PAT)