trigger:
  - release

pool:
  vmImage: ubuntu-latest

variables:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk

steps:
  - checkout: self
    fetchDepth: 0

  - task: JavaToolInstaller@0
    inputs:
      versionSpec: '21'
      jdkArchitectureOption: 'x64'
      jdkSourceOption: 'PreInstalled'
    displayName: Use Java 21

  - script: chmod +x ./gradlew
    displayName: Make gradlew executable

  - task: Cache@2
    displayName: Cache Gradle
    inputs:
      key: 'gradle | "$(Agent.OS)" | **/gradle-wrapper.properties'
      restoreKeys: |
        gradle | "$(Agent.OS)"
      path: '$(HOME)/.gradle/caches'

  - bash: |
      set -e
      yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --licenses
      "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" \
        "platforms;android-35" "build-tools;35.0.0" "platform-tools"
    displayName: Ensure Android SDK 35 is installed

  # ---- SonarCloud ----
  - task: SonarCloudPrepare@1
    displayName: Prepare SonarCloud analysis
    inputs:
      SonarCloud: 'Sonarqube Cloud'
      organization: 'ciscode'
      scannerMode: 'Other'
      projectKey: 'CISCODEAPPS_pkg-android-auth'
      projectName: 'pkg-android-auth'

  - bash: ./gradlew clean :testDebugUnitTest jacocoTestReport --stacktrace --info --no-daemon || true
    displayName: Run unit tests (debug) + coverage

  - bash: ./gradlew sonarqube --stacktrace --no-daemon
    displayName: Run SonarCloud analysis (Gradle)

  - task: SonarCloudPublish@1
    displayName: Publish SonarCloud Quality Gate
    inputs:
      pollingTimeoutSec: '300'

  - bash: ./gradlew :assembleRelease --no-daemon
    displayName: Build release AAR

  # ---- Optional: verify Central Portal credentials ----
  - bash: |
      set -euo pipefail
      echo "Checking Central Publisher API with provided credentials..."
      CODE=$(curl -sS -o /dev/null -w "%{http_code}" -u "$(CENTRAL_USERNAME):$(CENTRAL_PASSWORD)" \
        https://central.sonatype.com/api/v1/publisher/status || true)
      echo "Publisher status HTTP=$CODE"
      if [[ "$CODE" == "401" ]]; then
        echo "Invalid Central token (401)."
        exit 1
      fi
      exit 0
    displayName: Verify Central Portal token
    env:
      CENTRAL_USERNAME: $(CENTRAL_USERNAME)
      CENTRAL_PASSWORD: $(CENTRAL_PASSWORD)

  # ---- Download GPG private key from Azure Secure files ----
  - task: DownloadSecureFile@1
    name: gpgkey
    displayName: Download signing key (Secure file)
    inputs:
      secureFile: 'ciscode_private.asc'   # must match the file name in Library â†’ Secure files

  # ---- Validate the downloaded key (no secrets printed) ----
  - bash: |
      set -euo pipefail
      echo "--- gpg version ---"
      gpg --version || true

      KEYFILE="$(gpgkey.secureFilePath)"
      echo "Validating secure key file at: ${KEYFILE}"

      # Basic header/footer sanity checks
      head -n 1 "${KEYFILE}" | grep -q 'BEGIN PGP PRIVATE KEY BLOCK' || { echo "ERROR: Missing BEGIN marker"; exit 1; }
      tail -n 1 "${KEYFILE}" | grep -q 'END PGP PRIVATE KEY BLOCK' || { echo "ERROR: Missing END marker"; exit 1; }

      echo "--- gpg show-only import (should show 'sec'/'ssb') ---"
      # This prints metadata only; it does NOT import into the agent keyring.
      set +e
      OUT=$(gpg --batch --import-options show-only --import "${KEYFILE}" 2>&1)
      RC=$?
      set -e
      echo "$OUT"
      echo "Exit code: $RC"

      echo "$OUT" | grep -q '^sec' || { echo "ERROR: No 'sec' line found. This file is not a private key."; exit 1; }
      echo "Key validation: PASS"
    displayName: Validate signing key (show-only)

  # ---- Publish to Maven Central via nmcp aggregation (force secure-file usage) ----
  - bash: ./gradlew publishAggregationToCentralPortal --stacktrace --no-daemon
    displayName: Publish to Maven Central (Central Portal via nmcp)
    env:
      CENTRAL_USERNAME: $(CENTRAL_USERNAME)
      CENTRAL_PASSWORD: $(CENTRAL_PASSWORD)
      SIGNING_KEY_FILE: $(gpgkey.secureFilePath)   # path to downloaded ASCII key (used by build.gradle.kts)
      SIGNING_PASSWORD: $(SIGNING_PASSWORD)        # key passphrase
      SIGNING_KEY: ''                              # explicitly unset in case a var group still defines it

  # ---- Sync Azure DevOps 'release' branch to GitHub ONLY if pipeline succeeded ----
  - bash: |
      set -e

      git config user.name "azure-pipelines"
      git config user.email "azure-pipelines@users.noreply.github.com"

      # Add GitHub remote (if not already present)
      if ! git remote | grep -q github; then
        git remote add github https://$(GITHUB_PAT)@github.com/<ORG>/<REPO>.git
      fi

      # Ensure we're on release
      git checkout release

      # Push release branch to GitHub
      git push github release --force-with-lease
    displayName: Sync release branch to GitHub
    condition: succeeded()
    env:
      GITHUB_PAT: $(GITHUB_PAT)